// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
    id        Int      @id @default(autoincrement())
    username  String   @unique
    fullName  String?
    email     String   @unique
    password  String
    role      String   @default("user")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    clients   Client[]
    bids      Bid[]
    comments  Comment[]
    auditLogs AuditLog[]
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Client {
    id           Int      @id @default(autoincrement())
    name         String
    email        String
    phone        String?
    responsibleId Int?
    responsible  User?    @relation(fields: [responsibleId], references: [id])
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    bids         Bid[]
    clientObjects ClientObject[]
}

model ClientObject {
   id          Int      @id @default(autoincrement())
   clientId    Int
   brandModel  String
   stateNumber String
   equipment   String?
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
   client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
   bids        Bid[]
 }

 model Bid {
     id          Int      @id @default(autoincrement())
     clientId    Int
     bidTypeId   Int
     tema        String
     amount      Decimal  @db.Decimal(10, 2)
     status      String
     description String?
     clientObjectId Int?
     updNumber   String?
     updDate     DateTime?
     contract    String?
     createdBy   Int
     createdAt   DateTime @default(now())
     updatedAt   DateTime @updatedAt
     client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
     bidType     BidType  @relation(fields: [bidTypeId], references: [id])
     clientObject ClientObject? @relation(fields: [clientObjectId], references: [id])
     creator     User     @relation(fields: [createdBy], references: [id])
     comments    Comment[]
     bidSpecifications BidSpecification[]
     auditLogs   AuditLog[]
   }

model Equipment {
    id            Int      @id @default(autoincrement())
    name          String
    description   String?
    productCode   Int?
    sellingPrice  Decimal? @db.Decimal(10, 2)
    purchasePrice Decimal? @db.Decimal(10, 2)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Comment {
  id        Int      @id @default(autoincrement())
  bidId     Int
  userId    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SpecificationCategory {
  id            Int            @id @default(autoincrement())
  name          String
  description   String?
  parentId      Int?
  parent        SpecificationCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      SpecificationCategory[] @relation("CategoryHierarchy")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  specifications Specification[]
}

model Specification {
   id         Int                  @id @default(autoincrement())
   categoryId Int
   category   SpecificationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
   name       String
   discount   Decimal              @db.Decimal(5, 2)
   cost       Decimal              @db.Decimal(10, 2)
   createdAt  DateTime             @default(now())
   updatedAt  DateTime             @updatedAt
   bidSpecifications BidSpecification[]
}

model BidSpecification {
   id             Int          @id @default(autoincrement())
   bidId          Int
   bid            Bid          @relation(fields: [bidId], references: [id], onDelete: Cascade)
   specificationId Int
   specification  Specification @relation(fields: [specificationId], references: [id], onDelete: Cascade)
   executorIds    Int[]
   comment        String?
   createdAt      DateTime     @default(now())
   updatedAt      DateTime     @updatedAt
}

model Supplier {
    id        Int      @id @default(autoincrement())
    name      String
    entityType String
    inn       String
    phone     String?
    email     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}


model BidType {
      id          Int      @id @default(autoincrement())
      name        String   @unique
      description String?
      statuses    Json?
      transitions Json?
      createdAt   DateTime @default(now())
      updatedAt   DateTime @updatedAt
      bids        Bid[]
  }


model AuditLog {
    id        Int      @id @default(autoincrement())
    bidId     Int
    bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
    userId    Int
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    action    String
    details   String?
    createdAt DateTime @default(now())
}
