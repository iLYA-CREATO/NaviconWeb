generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int            @id @default(autoincrement())
  username        String         @unique
  fullName        String?
  email           String         @unique
  password        String
  role            String         @default("user")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  auditLogs       AuditLog[]
  bids            Bid[]          @relation("BidCreator")
  responsibleBids Bid[]          @relation("BidCurrentResponsible")
  bidFiles        BidFile[]
  clients         Client[]
  ClientObject    ClientObject[]
  comments        Comment[]
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  permissions Json?
}

model Client {
  id               Int                    @id @default(autoincrement())
  name             String
  email            String
  phone            String?
  responsibleId    Int?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  subjectForm      String?
  bids             Bid[]
  responsible      User?                  @relation(fields: [responsibleId], references: [id])
  attributeValues  ClientAttributeValue[]
  clientEquipments ClientEquipment[]
  clientObjects    ClientObject[]
}

model ClientObject {
  id            Int        @id @default(autoincrement())
  clientId      Int
  brandModel    String
  stateNumber   String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  equipmentId   Int?
  distance      Int        @default(0)
  region        String     @default("68")
  responsibleId Int?
  bids          Bid[]
  client        Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  equipment     Equipment? @relation(fields: [equipmentId], references: [id])
  User          User?      @relation(fields: [responsibleId], references: [id])
}

model Bid {
  id                         Int                 @id @default(autoincrement())
  clientId                   Int
  bidTypeId                  Int
  tema                       String
  amount                     Decimal             @db.Decimal(10, 2)
  status                     String
  description                String?
  clientObjectId             Int?
  updNumber                  String?
  updDate                    DateTime?
  createdBy                  Int
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime            @updatedAt
  workAddress                String?
  contactFullName            String?
  contactPhone               String?
  parentId                   Int?
  assignedAt                 DateTime?
  plannedReactionTimeMinutes Int?
  plannedResolutionDate      DateTime?
  spentTimeHours             Decimal?            @db.Decimal(10, 2)
  currentResponsibleUserId   Int?
  plannedDurationMinutes     Int?
  auditLogs                  AuditLog[]
  bidType                    BidType             @relation(fields: [bidTypeId], references: [id])
  client                     Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientObject               ClientObject?       @relation(fields: [clientObjectId], references: [id])
  creator                    User                @relation("BidCreator", fields: [createdBy], references: [id])
  currentResponsible         User?               @relation("BidCurrentResponsible", fields: [currentResponsibleUserId], references: [id])
  parent                     Bid?                @relation("BidHierarchy", fields: [parentId], references: [id])
  children                   Bid[]               @relation("BidHierarchy")
  attributeValues            BidAttributeValue[]
  bidEquipments              BidEquipment[]
  bidFiles                   BidFile[]
  bidSpecifications          BidSpecification[]
  clientEquipments           ClientEquipment[]
  comments                   Comment[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  bidId     Int
  userId    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SpecificationCategory {
  id             Int                     @id @default(autoincrement())
  name           String
  description    String?
  parentId       Int?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  specifications Specification[]
  parent         SpecificationCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children       SpecificationCategory[] @relation("CategoryHierarchy")
}

model Specification {
  id                Int                   @id @default(autoincrement())
  categoryId        Int
  name              String
  discount          Decimal               @db.Decimal(5, 2)
  cost              Decimal               @db.Decimal(10, 2)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  bidSpecifications BidSpecification[]
  category          SpecificationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

model BidSpecification {
  id              Int           @id @default(autoincrement())
  bidId           Int
  specificationId Int
  executorIds     Int[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  discount        Decimal       @default(0) @db.Decimal(5, 2)
  bid             Bid           @relation(fields: [bidId], references: [id], onDelete: Cascade)
  specification   Specification @relation(fields: [specificationId], references: [id], onDelete: Cascade)
}

model Supplier {
  id         Int         @id @default(autoincrement())
  name       String
  entityType String
  inn        String
  phone      String?
  email      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  equipment  Equipment[]
}

model BidType {
  id                         Int      @id @default(autoincrement())
  name                       String   @unique
  description                String?
  statuses                   Json?
  transitions                Json?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  plannedReactionTimeMinutes Int?
  plannedDurationMinutes     Decimal? @db.Decimal(10, 2)
  bids                       Bid[]
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  bidId     Int
  userId    Int
  action    String
  details   String?
  createdAt DateTime @default(now())
  bid       Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Warehouse {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Equipment {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  productCode      Int?              @unique
  purchasePrice    Decimal?          @db.Decimal(10, 2)
  sellingPrice     Decimal?          @db.Decimal(10, 2)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  images           String[]          @default([])
  description      String?
  category         String?
  supplierId       Int?
  bidEquipments    BidEquipment[]
  clientEquipments ClientEquipment[]
  clientObjects    ClientObject[]
  supplier         Supplier?         @relation(fields: [supplierId], references: [id])
}

model BidEquipment {
  id           Int       @id @default(autoincrement())
  bidId        Int
  equipmentId  Int
  imei         String?
  quantity     Int       @default(1)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  returnReason String?
  bid          Bid       @relation(fields: [bidId], references: [id], onDelete: Cascade)
  equipment    Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
}

model ClientEquipment {
  id          Int       @id @default(autoincrement())
  clientId    Int
  equipmentId Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bidId       Int?
  imei        String?
  bid         Bid?      @relation(fields: [bidId], references: [id])
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([clientId, equipmentId])
}

model ClientAttribute {
  id        Int                    @id @default(autoincrement())
  name      String
  type      String
  options   Json?
  isEnabled Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  values    ClientAttributeValue[]
}

model ClientAttributeValue {
  id          Int             @id @default(autoincrement())
  clientId    Int
  attributeId Int
  value       String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  attribute   ClientAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, attributeId])
}

model BidAttribute {
  id        Int                 @id @default(autoincrement())
  name      String
  type      String
  options   Json?
  isEnabled Boolean             @default(true)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  values    BidAttributeValue[]
}

model BidAttributeValue {
  id          Int          @id @default(autoincrement())
  bidId       Int
  attributeId Int
  value       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attribute   BidAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  bid         Bid          @relation(fields: [bidId], references: [id], onDelete: Cascade)

  @@unique([bidId, attributeId])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      String
  bidId     Int?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model BidFile {
  id           Int      @id @default(autoincrement())
  bidId        Int
  filename     String
  originalName String
  fileSize     Int
  mimeType     String?
  uploadedBy   Int
  createdAt    DateTime @default(now())
  bid          Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([bidId])
}

model EquipmentCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  parentId    Int?
  parent      EquipmentCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    EquipmentCategory[] @relation("CategoryHierarchy")
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model SubjectForm {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
}
